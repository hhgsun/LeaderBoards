<!doctype html>
<html>

<head>
  <title>SCORES</title>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"
    integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs"
    crossorigin="anonymous"></script>
  <style>
    #table {
      font-family: Arial, Helvetica, sans-serif;
      border-collapse: collapse;
      width: 100%;
    }

    #table td,
    #table th {
      border: 1px solid #ddd;
      padding: 8px;
    }

    #table tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #table tr:hover {
      background-color: #ddd;
    }

    #table th {
      padding-top: 12px;
      padding-bottom: 12px;
      text-align: left;
      background-color: #04AA6D;
      color: white;
    }
  </style>
</head>

<body>

  <input id="input_userid" placeholder="User Id" />
  <button id="btn-update">Update</button>

  <table id="table">
    <tr>
      <th>id</th>
      <th>score</th>
      <th>username</th>
      <th>country</th>
      <th>money</th>
      <th>rank</th>
    </tr>
    <tbody id="tbody">
      <!-- <tr>
      <td>{id}</td>
      <td>{score}</td>
    </tr> -->
    </tbody>
  </table>


  <!-- <script src="/socket.io/socket.io.js"></script> -->
  <script>
    let socket = io("ws://localhost:3000");
    let btnUpdate = document.getElementById("btn-update");
    let tbody = document.getElementById("tbody");
    let users = [];

    /* socket.on('sendAllUserToClient', function (data) {
      console.log('users refresh');
      users = [...data.users];
      renderUsersToTable();
    }); */

    fetch('http://localhost:3000/players')
      .then(res => res.json())
      .then(res => {
        users = res;
        renderUsersToTable();
      })
      .catch(err => console.log(err));

    socket.on('sendUserToClient', function (userData) {
      console.log('user update', userData);
      if (userData && userData._id != null) {
        const findIndex = users.findIndex((u) => u._id = userData._id);
        if (findIndex != -1) {
          users[findIndex] = { ...users[findIndex], ...userData };
        }
      }
      renderUsersToTable();
    });

    function renderUsersToTable() {
      tbody.innerHTML = "";
      users.sort((a, b) => b.score - a.score);
      users.forEach(user => {
        const tr = document.createElement("tr");
        const thId = document.createElement('td');
        thId.innerHTML = user._id;
        const thScore = document.createElement('td');
        thScore.innerHTML = user.score;
        const thUsername = document.createElement('td');
        thUsername.innerHTML = user.username;
        const thCountry = document.createElement('td');
        thCountry.innerHTML = user.country;
        const thMoney = document.createElement('td');
        thMoney.innerHTML = user.money;
        const thRank = document.createElement('td');
        thRank.innerHTML = user.rank;
        tr.append(thId);
        tr.append(thScore);
        tr.append(thUsername);
        tr.append(thCountry);
        tr.append(thMoney);
        tr.append(thRank);
        tbody.append(tr);
      });
    }

    btnUpdate.onclick = () => {
      const input_userid = document.getElementById('input_userid');
      if (input_userid.value != null) {
        socket.emit('updateFromClient', { userId: input_userid.value });
      } else {
        alert("id yok " + input_userid.value);
      }
    }

  </script>

</body>

</html>